<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন ড্যাশবোর্ড</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        danger: {
                            500: '#ef4444',
                            600: '#dc2626',
                        },
                        success: {
                            500: '#10b981',
                            600: '#059669',
                        }
                    },
                    fontFamily: {
                        'bengali': ['"Noto Sans Bengali"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 1.5s infinite alternate',
                        'gradient-text': 'gradient-text 5s ease infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        glow: {
                            '0%, 100%': {
                                'text-shadow': '0 0 5px #fff, 0 0 10px #0ea5e9, 0 0 15px #3b82f6',
                                'color': '#0ea5e9',
                            },
                            '50%': {
                                'text-shadow': '0 0 10px #fff, 0 0 20px #3b82f6, 0 0 30px #1d4ed8',
                                'color': '#3b82f6',
                            }
                        },
                        'gradient-text': {
                            '0%, 100%': {
                                'background-size': '200% 200%',
                                'background-position': 'left center',
                            },
                            '50%': {
                                'background-size': '200% 200%',
                                'background-position': 'right center',
                            }
                        }
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            background-color: #f8fafc;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .table-row-hover:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .notice-badge {
            animation: pulse-slow 2s infinite;
        }
        #toast {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .rahathossain-copyright {
            background-image: linear-gradient(to right, #0ea5e9, #6366f1, #0ea5e9);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            animation: gradient-text 5s ease infinite;
        }
        .date-navigator button {
            transition: transform 0.2s, background-color 0.2s;
        }
        .date-navigator button:hover {
            transform: scale(1.1);
        }

        /* Print styles */
        @media print {
            body > *:not(.printable) {
                display: none;
            }
            .printable {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            .printable h1, .printable h2, .printable p {
                color: #000 !important;
            }
            .printable table {
                width: 100%;
                border-collapse: collapse;
            }
            .printable th, .printable td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
            }
        }
    </style>
</head>
<body class="antialiased bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen flex flex-col">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 glass-card rounded-2xl shadow-xl animate__animated animate__fadeIn">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg mb-4">
                    <i class="fas fa-user-shield text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">অ্যাডমিন প্যানেল</h1>
                <p class="text-gray-500 mt-2">প্রবেশ করতে আপনার গুগল অ্যাকাউন্ট ব্যবহার করুন</p>
            </div>
            <button id="login-btn" class="w-full flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold rounded-xl shadow-md hover:shadow-lg transition-all duration-300 hover:from-blue-700 hover:to-blue-600">
                <i class="fab fa-google text-xl mr-3"></i>
                গুগল দিয়ে লগইন করুন
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden animate__animated animate__shakeX"></p>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="hidden flex-grow flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                            <i class="fas fa-tachometer-alt text-lg"></i>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800">ড্যাশবোর্ড</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right hidden sm:block">
                            <p id="user-name" class="font-semibold text-gray-700"></p>
                            <p id="user-email" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="logout-btn" class="flex items-center px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold rounded-lg shadow-sm hover:shadow-md transition-all duration-300 hover:from-red-600 hover:to-red-700">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            লগ আউট
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow">
            <!-- Stats and Notice Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Stats Cards -->
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center animate__animated animate__fadeInUp">
                        <div class="p-4 bg-blue-100 rounded-xl text-blue-600">
                            <i class="fas fa-download text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 font-medium">মোট ডাউনলোড (সর্বকালীন)</h3>
                            <p id="total-downloads" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center animate__animated animate__fadeInUp animate__delay-1s">
                        <div class="p-4 bg-green-100 rounded-xl text-green-600">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 font-medium">অনন্য ব্যবহারকারী (সর্বকালীন)</h3>
                            <p id="unique-users" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center animate__animated animate__fadeInUp animate__delay-2s">
                        <div class="p-4 bg-purple-100 rounded-xl text-purple-600">
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 font-medium">সর্বশেষ ডাউনলোড</h3>
                            <p id="last-download" class="text-xl font-bold text-gray-800">কোনো ডেটা নেই</p>
                        </div>
                    </div>
                </div>
                
                <!-- Notice Section -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden animate__animated animate__fadeIn">
                    <div class="bg-red-600 px-6 py-4 flex items-center">
                        <i class="fas fa-bullhorn text-white text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-white">নোটিশ বোর্ড</h2>
                    </div>
                    <div class="p-6">
                        <div id="notice-container" class="hidden">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 text-red-500 mr-3 mt-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div>
                                    <p id="notice-text" class="text-gray-700"></p>
                                    <p id="notice-time" class="text-sm text-gray-500 mt-2"></p>
                                </div>
                            </div>
                        </div>
                        <div id="no-notice" class="text-center py-4 text-gray-500">
                            <i class="fas fa-info-circle text-xl mb-2"></i>
                            <p>কোনো নোটিশ পাওয়া যায়নি</p>
                        </div>
                        <div class="mt-6">
                            <h3 class="font-medium text-gray-700 mb-2">নতুন নোটিশ যোগ করুন</h3>
                            <textarea id="notice-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="এখানে নোটিশ লিখুন..."></textarea>
                            <button id="save-notice-btn" class="mt-3 w-full flex items-center justify-center px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold rounded-lg shadow-sm hover:shadow-md transition-all duration-300">
                                <i class="fas fa-save mr-2"></i>
                                নোটিশ সেভ করুন
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drive Link Management -->
            <section class="bg-white p-6 rounded-xl shadow-sm mb-8 animate__animated animate__fadeIn">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-link text-blue-500 mr-2"></i>
                        সিলেবাস ড্রাইভ লিংক
                    </h2>
                    <span id="link-status" class="text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-800 hidden">
                        <i class="fas fa-check-circle mr-1"></i>
                        সফলভাবে আপডেট হয়েছে
                    </span>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-grow relative">
                        <i class="fas fa-link absolute left-3 top-3 text-gray-400"></i>
                        <input type="url" id="drive-link-input" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://drive.google.com/...">
                    </div>
                    <button id="save-link-btn" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-gradient-to-r from-green-600 to-green-500 text-white font-semibold rounded-lg shadow-sm hover:shadow-md transition-all duration-300">
                        <i class="fas fa-save mr-2"></i>
                        লিংক সেভ করুন
                    </button>
                </div>
            </section>

            <!-- Data Table Section -->
            <section class="bg-white rounded-xl shadow-sm overflow-hidden animate__animated animate__fadeIn">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-table text-blue-500 mr-2"></i>
                            ডাউনলোড পরিসংখ্যান
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button id="print-btn" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:shadow-md transition-all duration-300">
                                <i class="fas fa-print mr-2"></i>
                                প্রিন্ট করুন
                            </button>
                            <button id="delete-daily-btn" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg shadow-sm hover:shadow-md transition-all duration-300">
                                <i class="fas fa-trash-alt mr-2"></i>
                                আজকের ডেটা মুছুন
                            </button>
                        </div>
                    </div>

                    <!-- Date Navigation -->
                    <div class="flex items-center justify-center gap-4 mb-4 date-navigator">
                        <button id="prev-day-btn" class="p-2 text-gray-600 bg-gray-100 rounded-full hover:bg-gray-200">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <input type="date" id="date-picker" class="px-4 py-2 border border-gray-300 rounded-lg text-center font-semibold text-gray-700">
                        <button id="next-day-btn" class="p-2 text-gray-600 bg-gray-100 rounded-full hover:bg-gray-200">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div class="relative">
                        <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="খুঁজুন...">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto text-left">
                        <thead class="bg-gray-50 text-gray-700 uppercase text-sm">
                            <tr>
                                <th class="px-6 py-3">#</th>
                                <th class="px-6 py-3">নাম</th>
                                <th class="px-6 py-3">রোল</th>
                                <th class="px-6 py-3">সময়</th>
                                <th class="px-6 py-3 text-center">ডাউনলোড সংখ্যা</th>
                                <th class="px-6 py-3 text-center">অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body" class="divide-y divide-gray-200">
                            <!-- Data will be injected here by JS -->
                            <tr>
                                <td colspan="6" class="text-center py-10">
                                    <i class="fas fa-spinner fa-spin fa-2x text-gray-400"></i>
                                    <p class="mt-2">ডেটা লোড হচ্ছে...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
        
        <!-- Footer with Copyright -->
        <footer class="bg-gray-100 text-gray-500 text-center py-4 mt-8 shadow-inner">
            <div class="container mx-auto">
                <p class="text-sm">© <span class="rahathossain-copyright">RAHAT HOSSAIN</span></p>
            </div>
        </footer>
    </div>

    <!-- Print Confirmation Modal -->
    <div id="print-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm z-10 animate__animated animate__zoomIn">
            <div class="p-6 text-center">
                <i class="fas fa-print text-5xl text-blue-500 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">আপনি কি প্রিন্ট করতে চান?</h3>
                <p class="text-gray-600 mb-6">কোন ডেটা প্রিন্ট করতে চান তা নির্বাচন করুন।</p>
                <div class="flex flex-col space-y-3">
                    <button id="print-daily-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        আজকের ডেটা প্রিন্ট
                    </button>
                    <button id="print-all-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        সকল ডেটা প্রিন্ট
                    </button>
                    <button id="print-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        বাতিল করুন
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm z-10 animate__animated animate__zoomIn">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4 animate__animated animate__bounceIn"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">আপনি নিশ্চিত?</h3>
                <p id="delete-message" class="text-gray-600 mb-6">এই ডেটা মুছে দিলে তা আর ফেরত আনা যাবে না।</p>
                <div class="flex space-x-3">
                    <button id="delete-confirm-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">
                        ডিলিট করুন
                    </button>
                    <button id="delete-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        বাতিল করুন
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center transform translate-y-10 opacity-0 z-50">
        <i id="toast-icon" class="fas fa-check-circle mr-3"></i>
        <p id="toast-message"></p>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, getDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAyOg_9r6B2oEw5tyRhDYvz5KRCvknPNtE",
            authDomain: "edtech-success-hub.firebaseapp.com",
            projectId: "edtech-success-hub",
            storageBucket: "edtech-success-hub.appspot.com",
            messagingSenderId: "898562954156",
            appId: "1:898562954156:web:852b093759df69ed7a2009"
        };
        
        // Allowed admin email
        const ADMIN_EMAIL = "smartwork19999@gmail.com";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // DOM Elements
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const totalDownloadsEl = document.getElementById('total-downloads');
        const uniqueUsersEl = document.getElementById('unique-users');
        const lastDownloadEl = document.getElementById('last-download');
        const driveLinkInput = document.getElementById('drive-link-input');
        const saveLinkBtn = document.getElementById('save-link-btn');
        const linkStatus = document.getElementById('link-status');
        const statsTableBody = document.getElementById('stats-table-body');
        const searchInput = document.getElementById('search-input');
        const noticeContainer = document.getElementById('notice-container');
        const noticeText = document.getElementById('notice-text');
        const noticeTime = document.getElementById('notice-time');
        const noNotice = document.getElementById('no-notice');
        const noticeInput = document.getElementById('notice-input');
        const saveNoticeBtn = document.getElementById('save-notice-btn');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');

        const datePicker = document.getElementById('date-picker');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const printBtn = document.getElementById('print-btn');
        const deleteDailyBtn = document.getElementById('delete-daily-btn');
        const printModal = document.getElementById('print-modal');
        const printDailyBtn = document.getElementById('print-daily-btn');
        const printAllBtn = document.getElementById('print-all-btn');
        const printCancelBtn = document.getElementById('print-cancel-btn');
        const deleteModal = document.getElementById('delete-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const deleteMessage = document.getElementById('delete-message');

        let unsubscribeStats = null; // To hold the listener unsub function
        let statsData = []; // To hold all stats data for searching
        let currentDeleteDocId = null; // To hold the doc ID for deletion
        let currentViewDate = new Date(); // State for the selected date

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                // Admin is logged in
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                setupDashboard(user);
            } else {
                // No user or wrong user
                if (user) { // If a non-admin user is logged in
                    signOut(auth); // Force log out
                    showToast('আপনার এই ড্যাশবোর্ড অ্যাক্সেস করার অনুমতি নেই।', 'error');
                }
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                if (unsubscribeStats) {
                    unsubscribeStats(); // Stop listening to data when logged out
                }
            }
        });

        loginBtn.addEventListener('click', () => {
            loginError.classList.add('hidden');
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Login Error:", error);
                    loginError.textContent = 'লগইন করার সময় একটি সমস্যা হয়েছে।';
                    loginError.classList.remove('hidden');
                    loginError.classList.add('animate__animated', 'animate__shakeX');
                    setTimeout(() => {
                        loginError.classList.remove('animate__animated', 'animate__shakeX');
                    }, 1000);
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            showToast('সফলভাবে লগ আউট করা হয়েছে।');
        });

        // --- Dashboard Setup ---
        function setupDashboard(user) {
            userNameEl.textContent = user.displayName;
            userEmailEl.textContent = user.email;
            
            // Set initial date picker value
            datePicker.value = formatDate(currentViewDate);
            
            fetchDashboardStats(); // Fetch all-time stats
            fetchDownloadStatsForDate(currentViewDate); // Fetch today's stats
            fetchDriveLink();
            fetchNotice();
        }

        // --- Date Navigation ---
        datePicker.addEventListener('change', (e) => {
            currentViewDate = new Date(e.target.value);
            fetchDownloadStatsForDate(currentViewDate);
        });

        prevDayBtn.addEventListener('click', () => {
            currentViewDate.setDate(currentViewDate.getDate() - 1);
            datePicker.value = formatDate(currentViewDate);
            fetchDownloadStatsForDate(currentViewDate);
        });

        nextDayBtn.addEventListener('click', () => {
            currentViewDate.setDate(currentViewDate.getDate() + 1);
            datePicker.value = formatDate(currentViewDate);
            fetchDownloadStatsForDate(currentViewDate);
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Data Fetching ---
        function fetchDashboardStats() {
            // Fetch total stats (all time)
            const statsCollection = collection(db, 'downloadStats');
            onSnapshot(statsCollection, (snapshot) => {
                let totalCount = 0;
                let uniqueUsers = snapshot.size;
                let lastDownload = 'কোনো ডেটা নেই';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalCount += data.downloadCount || 1;
                });

                if (snapshot.docs.length > 0) {
                    const sortedDocs = snapshot.docs.sort((a, b) => new Date(b.data().firstDownload) - new Date(a.data().firstDownload));
                    lastDownload = new Date(sortedDocs[0].data().firstDownload).toLocaleString('bn-BD', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: true
                    });
                }
                
                totalDownloadsEl.textContent = totalCount.toLocaleString('bn-BD');
                uniqueUsersEl.textContent = uniqueUsers.toLocaleString('bn-BD');
                lastDownloadEl.textContent = lastDownload;
            });
        }

        function fetchDownloadStatsForDate(date) {
            if (unsubscribeStats) {
                unsubscribeStats(); // Unsubscribe from previous listener
            }

            const startOfDay = new Date(date);
            startOfDay.setHours(0, 0, 0, 0);
            
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);
            
            const statsCollection = collection(db, 'downloadStats');
            const q = query(statsCollection, where('firstDownload', '>=', startOfDay.toISOString()), where('firstDownload', '<=', endOfDay.toISOString()));
            
            unsubscribeStats = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    statsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">এই তারিখে কোনো ডেটা পাওয়া যায়নি।</td></tr>`;
                    statsData = [];
                    return;
                }
                
                statsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable(statsData);
            }, (error) => {
                console.error("Error fetching daily stats:", error);
                statsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-500">ডেটা লোড করতে সমস্যা হয়েছে।</td></tr>`;
            });
        }

        function renderTable(data) {
            statsTableBody.innerHTML = ''; // Clear previous data
            
            if (data.length === 0) {
                statsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">কোনো ফলাফল পাওয়া যায়নি।</td></tr>`;
                return;
            }
            
            data.forEach((stat, index) => {
                const row = document.createElement('tr');
                row.className = 'table-row-hover';
                
                const downloadTime = new Date(stat.firstDownload).toLocaleTimeString('bn-BD', {
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                });

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${(index + 1).toLocaleString('bn-BD')}</td>
                    <td class="px-6 py-4">${stat.name}</td>
                    <td class="px-6 py-4">${stat.roll}</td>
                    <td class="px-6 py-4">${downloadTime}</td>
                    <td class="px-6 py-4 text-center font-bold text-blue-600">${(stat.downloadCount || 1).toLocaleString('bn-BD')}</td>
                    <td class="px-6 py-4 text-center">
                        <button class="text-red-500 hover:text-red-700 transition-colors" onclick="showDeleteModal('${stat.id}', '${stat.name}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                statsTableBody.appendChild(row);
            });
        }

        async function fetchDriveLink() {
            const docRef = doc(db, "settings", "driveLink");
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    driveLinkInput.value = docSnap.data().url;
                } else {
                    console.log("No drive link document found!");
                }
            } catch (error) {
                console.error("Error fetching drive link:", error);
            }
        }

        async function fetchNotice() {
            const docRef = doc(db, "settings", "notice");
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().text) {
                    noticeText.textContent = docSnap.data().text;
                    noticeTime.textContent = new Date(docSnap.data().timestamp).toLocaleString('bn-BD', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: true
                    });
                    noticeContainer.classList.remove('hidden');
                    noNotice.classList.add('hidden');
                } else {
                    noticeContainer.classList.add('hidden');
                    noNotice.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching notice:", error);
            }
        }

        // --- Data Saving ---
        saveLinkBtn.addEventListener('click', async () => {
            const link = driveLinkInput.value.trim();
            // Allow saving empty string for link
            const docRef = doc(db, "settings", "driveLink");
            
            const button = saveLinkBtn;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> <span>সেভ হচ্ছে...</span>`;

            try {
                await setDoc(docRef, { url: link });
                showToast('লিংক সফলভাবে সেভ করা হয়েছে!');
                
                // Show success status
                linkStatus.classList.remove('hidden');
                setTimeout(() => {
                    linkStatus.classList.add('hidden');
                }, 3000);
            } catch (error) {
                console.error("Error saving link:", error);
                showToast('লিংক সেভ করতে সমস্যা হয়েছে।', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });

        saveNoticeBtn.addEventListener('click', async () => {
            const text = noticeInput.value.trim();
            if (!text) {
                showToast('অনুগ্রহ করে নোটিশ লিখুন।', 'error');
                return;
            }

            const button = saveNoticeBtn;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> <span>সেভ হচ্ছে...</span>`;

            const docRef = doc(db, "settings", "notice");
            try {
                await setDoc(docRef, { 
                    text: text,
                    timestamp: new Date().toISOString()
                });
                showToast('নোটিশ সফলভাবে সেভ করা হয়েছে!');
                fetchNotice();
                noticeInput.value = '';
            } catch (error) {
                console.error("Error saving notice:", error);
                showToast('নোটিশ সেভ করতে সমস্যা হয়েছে।', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });

        // --- Delete Functions ---
        window.showDeleteModal = (docId, name) => {
            currentDeleteDocId = docId;
            deleteMessage.innerHTML = `আপনি কি <span class="font-bold text-gray-800">` + name + `</span> এর ডেটা মুছে ফেলতে চান?`;
            deleteModal.classList.remove('hidden');
        };

        deleteDailyBtn.addEventListener('click', () => {
            currentDeleteDocId = 'daily';
            deleteMessage.innerHTML = `আপনি কি এই তারিখের <span class="font-bold text-red-500">সকল</span> ডেটা মুছে ফেলতে চান?`;
            deleteModal.classList.remove('hidden');
        });

        deleteConfirmBtn.addEventListener('click', async () => {
            if (currentDeleteDocId === 'daily') {
                await deleteDailyData();
            } else {
                await deleteSingleDocument(currentDeleteDocId);
            }
            deleteModal.classList.add('hidden');
        });

        deleteCancelBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            currentDeleteDocId = null;
        });

        async function deleteSingleDocument(docId) {
            try {
                await deleteDoc(doc(db, 'downloadStats', docId));
                showToast('ডেটা সফলভাবে মুছে ফেলা হয়েছে!', 'success');
            } catch (error) {
                console.error("Error deleting document:", error);
                showToast('ডেটা মুছে ফেলতে সমস্যা হয়েছে।', 'error');
            }
        }

        async function deleteDailyData() {
            const startOfDay = new Date(currentViewDate);
            startOfDay.setHours(0, 0, 0, 0);
            
            const endOfDay = new Date(currentViewDate);
            endOfDay.setHours(23, 59, 59, 999);

            try {
                const q = query(collection(db, 'downloadStats'), where('firstDownload', '>=', startOfDay.toISOString()), where('firstDownload', '<=', endOfDay.toISOString()));
                const querySnapshot = await getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                showToast('এই দিনের সমস্ত ডেটা সফলভাবে মুছে ফেলা হয়েছে!', 'success');
            } catch (error) {
                console.error("Error deleting daily data:", error);
                showToast('এই দিনের ডেটা মুছে ফেলতে সমস্যা হয়েছে।', 'error');
            }
        }

        // --- Print Functions ---
        printBtn.addEventListener('click', () => {
            printModal.classList.remove('hidden');
        });

        printCancelBtn.addEventListener('click', () => {
            printModal.classList.add('hidden');
        });

        printDailyBtn.addEventListener('click', () => {
            printData(statsData, `ডাউনলোড পরিসংখ্যান (${formatDate(currentViewDate)})`);
            printModal.classList.add('hidden');
        });

        printAllBtn.addEventListener('click', async () => {
            const statsCollection = collection(db, 'downloadStats');
            const querySnapshot = await getDocs(statsCollection);
            const allData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            printData(allData, 'সকল ডাউনলোড পরিসংখ্যান');
            printModal.classList.add('hidden');
        });

        function printData(data, title) {
            const printWindow = window.open('', '_blank');
            const tableRows = data.map((stat, index) => {
                const downloadTime = new Date(stat.firstDownload).toLocaleString('bn-BD', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                });
                return `
                    <tr>
                        <td>${(index + 1).toLocaleString('bn-BD')}</td>
                        <td>${stat.name}</td>
                        <td>${stat.roll}</td>
                        <td>${downloadTime}</td>
                        <td style="text-align:center;">${(stat.downloadCount || 1).toLocaleString('bn-BD')}</td>
                    </tr>
                `;
            }).join('');

            printWindow.document.write(`
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: 'Noto Sans Bengali', sans-serif; margin: 20px; }
                        h1 { text-align: center; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>নাম</th>
                                <th>রোল</th>
                                <th>সময়</th>
                                <th style="text-align:center;">ডাউনলোড সংখ্যা</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // --- Search Functionality ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) {
                renderTable(statsData);
                return;
            }
            
            const filteredData = statsData.filter(stat => 
                stat.name.toLowerCase().includes(searchTerm) || 
                stat.roll.toLowerCase().includes(searchTerm)
            );
            
            renderTable(filteredData);
        });

        // --- Utility ---
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            
            // Set icon and color based on type
            if (type === 'error') {
                toast.className = 'fixed bottom-5 right-5 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center z-50';
                toastIcon.className = 'fas fa-exclamation-circle mr-3';
            } else {
                toast.className = 'fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center z-50';
                toastIcon.className = 'fas fa-check-circle mr-3';
            }
            
            // Show toast
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

    </script>
</body>
    </html>
