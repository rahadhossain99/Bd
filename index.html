<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন ড্যাশবোর্ড</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            background-color: #f1f5f9;
        }
        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .table-auto th, .table-auto td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .table-auto tbody tr:last-child td {
            border-bottom: none;
        }
        .table-auto tbody tr:hover {
            background-color: #f8fafc;
        }
        #toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen bg-slate-200">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
            <div>
                <i class="fas fa-user-shield fa-3x text-blue-600"></i>
                <h1 class="text-2xl font-bold text-gray-800 mt-4">অ্যাডমিন প্যানেল</h1>
                <p class="text-gray-500 mt-1">লগইন করতে অনুগ্রহ করে ادامه দিন</p>
            </div>
            <button id="login-btn" class="w-full inline-flex justify-center items-center px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                <i class="fab fa-google mr-3"></i>
                গুগল দিয়ে লগইন করুন
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-tachometer-alt text-2xl text-blue-600"></i>
                        <h1 class="text-xl font-bold text-gray-800 ml-3">ড্যাশবোর্ড</h1>
                    </div>
                    <div class="flex items-center">
                        <div class="text-right mr-4">
                            <p id="user-name" class="font-semibold text-gray-700"></p>
                            <p id="user-email" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="logout-btn" class="flex items-center px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-sm hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            লগ আউট
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Stats Section -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center">
                    <div class="p-4 bg-blue-100 rounded-full">
                        <i class="fas fa-download fa-2x text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-gray-500 font-medium">মোট ডাউনলোড</h3>
                        <p id="total-downloads" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </section>

            <!-- Drive Link Management -->
            <section class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">সিলেবাস ড্রাইভ লিংক</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="url" id="drive-link-input" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="এখানে গুগল ড্রাইভ লিংক পেস্ট করুন">
                    <button id="save-link-btn" class="w-full sm:w-auto flex items-center justify-center px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-sm hover:bg-green-700 transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        <span>লিংক সেভ করুন</span>
                    </button>
                </div>
            </section>

            <!-- Data Table Section -->
            <section class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">ডাউনলোড পরিসংখ্যান</h2>
                    <p class="text-gray-500 mt-1">যারা সিলেবাস ডাউনলোড করেছে তাদের তালিকা।</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto text-left text-gray-600">
                        <thead class="bg-gray-50 text-gray-700 uppercase text-sm">
                            <tr>
                                <th class="w-1/12">#</th>
                                <th class="w-4/12">নাম</th>
                                <th class="w-2/12">রোল</th>
                                <th class="w-4/12">ডাউনলোডের সময়</th>
                                <th class="w-1/12 text-center">ডাউনলোড সংখ্যা</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body">
                            <!-- Data will be injected here by JS -->
                            <tr>
                                <td colspan="5" class="text-center py-10">
                                    <i class="fas fa-spinner fa-spin fa-2x text-gray-400"></i>
                                    <p class="mt-2">লোড হচ্ছে...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAyOg_9r6B2oEw5tyRhDYvz5KRCvknPNtE",
            authDomain: "edtech-success-hub.firebaseapp.com",
            projectId: "edtech-success-hub",
            storageBucket: "edtech-success-hub.appspot.com",
            messagingSenderId: "898562954156",
            appId: "1:898562954156:web:852b093759df69ed7a2009"
        };
        
        // Allowed admin email
        const ADMIN_EMAIL = "smartwork19999@gmail.com";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // DOM Elements
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const totalDownloadsEl = document.getElementById('total-downloads');
        const driveLinkInput = document.getElementById('drive-link-input');
        const saveLinkBtn = document.getElementById('save-link-btn');
        const statsTableBody = document.getElementById('stats-table-body');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        let unsubscribeStats = null; // To hold the listener unsub function

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                // Admin is logged in
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                setupDashboard(user);
            } else {
                // No user or wrong user
                if (user) { // If a non-admin user is logged in
                    signOut(auth); // Force log out
                    showToast('আপনার এই ড্যাশবোর্ড অ্যাক্সেস করার অনুমতি নেই।', 'error');
                }
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                if (unsubscribeStats) {
                    unsubscribeStats(); // Stop listening to data when logged out
                }
            }
        });

        loginBtn.addEventListener('click', () => {
            loginError.classList.add('hidden');
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Login Error:", error);
                    loginError.textContent = 'লগইন করার সময় একটি সমস্যা হয়েছে।';
                    loginError.classList.remove('hidden');
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            showToast('সফলভাবে লগ আউট করা হয়েছে।');
        });

        // --- Dashboard Setup ---
        function setupDashboard(user) {
            userNameEl.textContent = user.displayName;
            userEmailEl.textContent = user.email;
            fetchDownloadStats();
            fetchDriveLink();
        }

        // --- Data Fetching ---
        function fetchDownloadStats() {
            const statsCollection = collection(db, 'downloadStats');
            unsubscribeStats = onSnapshot(statsCollection, (snapshot) => {
                if (snapshot.empty) {
                    statsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">এখনো কোনো ডেটা পাওয়া যায়নি।</td></tr>`;
                    totalDownloadsEl.textContent = '0';
                    return;
                }
                
                let totalCount = 0;
                const statsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    totalCount += data.downloadCount || 1; // Sum up download counts
                    return { id: doc.id, ...data };
                });
                
                // Sort by date, newest first
                statsData.sort((a, b) => new Date(b.firstDownload) - new Date(a.firstDownload));

                totalDownloadsEl.textContent = snapshot.size.toLocaleString('bn-BD'); // Total unique downloaders
                
                statsTableBody.innerHTML = ''; // Clear previous data
                statsData.forEach((stat, index) => {
                    const row = document.createElement('tr');
                    const downloadTime = new Date(stat.firstDownload).toLocaleString('bn-BD', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: true
                    });

                    row.innerHTML = `
                        <td>${(index + 1).toLocaleString('bn-BD')}</td>
                        <td>${stat.name}</td>
                        <td>${stat.roll}</td>
                        <td>${downloadTime}</td>
                        <td class="text-center font-bold">${(stat.downloadCount || 1).toLocaleString('bn-BD')}</td>
                    `;
                    statsTableBody.appendChild(row);
                });

            }, (error) => {
                console.error("Error fetching stats:", error);
                statsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-500">ডেটা লোড করতে সমস্যা হয়েছে।</td></tr>`;
            });
        }

        async function fetchDriveLink() {
            const docRef = doc(db, "settings", "driveLink");
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    driveLinkInput.value = docSnap.data().url;
                } else {
                    console.log("No drive link document found!");
                }
            } catch (error) {
                console.error("Error fetching drive link:", error);
            }
        }

        // --- Data Saving ---
        saveLinkBtn.addEventListener('click', async () => {
            const link = driveLinkInput.value.trim();
            if (!link) {
                showToast('অনুগ্রহ করে একটি লিংক দিন।', 'error');
                return;
            }

            const button = saveLinkBtn;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> <span>সেভ হচ্ছে...</span>`;

            const docRef = doc(db, "settings", "driveLink");
            try {
                await setDoc(docRef, { url: link });
                showToast('লিংক সফলভাবে সেভ করা হয়েছে!');
            } catch (error) {
                console.error("Error saving link:", error);
                showToast('লিংক সেভ করতে সমস্যা হয়েছে।', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });

        // --- Utility ---
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'}`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

    </script>
</body>
</html>
